require(["jquery","plupload","qiniu"],function(e){function t(e,t){for(var i=0;i<e.length;i++)if(e[i]==t){e.splice(i,1);break}}function i(t,i){var n=e("#"+t).find(".set-cover");n.attr("data-url",i),n.show()}function n(t){var i=e("#"+t.id);i.find(".up-progress").remove(),i.find(".remove").remove(),i.find(".success").show()}function l(t){var i=e("#"+t.id).find(".up-progress");i.css("width",t.percent+"%")}function r(t){e("#up-imgs").attr("disabled",!t)}function a(t){e("#pickfiles").attr("disabled",!t),k.disableBrowse(!t)}function s(e){var t=window.URL||window.webkitURL,i=t.createObjectURL(e.getNative());return i}function c(e){var t=f();if(console.log(t),"safari"==t||"ie9"==t){var i=new o.Image;i.onload=function(){console.log("load success"),this.downsize(120,120,!0);var t=this.getAsDataURL();u(t,e.id)},i.onerror=function(e){console.log(e,"出错了")},i.load(e.getSource())}else{var n=s(e);u(n,e.id)}}function u(t,i){var n='<li style="background-image:url('+t+')"><span class="glyphicon success glyphicon-ok"></span><span class="set-cover">设为封面</span><span class="glyphicon remove glyphicon-remove"></span><div class="up-progress"></div></li>',o=e(n);o.attr("id",i),e(".img-preview-list").append(o)}function f(){var e,t={},i=navigator.userAgent.toLowerCase();return(e=i.match(/msie ([\d.]+)/))?t.ie=e[1]:(e=i.match(/firefox\/([\d.]+)/))?t.firefox=e[1]:(e=i.match(/chrome\/([\d.]+)/))?t.chrome=e[1]:(e=i.match(/opera.([\d.]+)/))?t.opera=e[1]:(e=i.match(/version\/([\d.]+).*safari/))?t.safari=e[1]:0,t.chrome?"chrome":t.firefox?"firefox":t.ie?"9.0"==t.ie?"ie9":"ie":t.opera?"opera":t.safari?"safari":void 0}function g(){var t="",i=e("textarea");t="<p>"+i.val()+"</p>",e.each(m,function(){t=t+"<p><img src="+this+"></p>"}),i.val(t)}function p(){var t=e(".form-filed"),i=t.find('input[name="pid"]').val(),n=t.find('input[name="product"]').val(),o=t.find('input[name="thumbnail"]').val(),l=e('input[name="title"]').val(),r=e("textarea").val();if(e.trim(i).length&&e.trim(n).length&&e.trim(o).length&&e.trim(r).length&&e.trim(l).length)if(m.length>=d){if("NaN"!=Number(i).toString()&&Number(i)>0&&"NaN"!=Number(n).toString()&&Number(n)>0){if(e.trim(r).length>=30)return g(),!0;alert("中奖感言至少30个字哦")}}else alert("至少需要上传"+d+"张商品图片");else 0==e.trim(o).length?alert("你还为晒单设置封面呢"):0==e.trim(l).length?alert("晒单标题不能为空哦"):alert("出错了，骚年你到底做了什么啊??")}Date.prototype.format=function(e){var t={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};/(y+)/.test(e)&&(e=e.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var i in t)new RegExp("("+i+")").test(e)&&(e=e.replace(RegExp.$1,1==RegExp.$1.length?t[i]:("00"+t[i]).substr((""+t[i]).length)));return e};var d=2,h=4,m=(location.pathname,[]),v="10MB",b="http://img.aixunbang.com/",w="/get/qiniu/uptoken";e.each(e(".img-preview-list").find("li"),function(){var t=e(this);t.data("url").indexOf(b)>=0&&m.push(t.data("url"))}),e(".go-back").on("click",function(){history.back()}),console.log(m);var k=Qiniu.uploader({runtimes:"html5,flash,html4",browse_button:"pickfiles",uptoken_url:w,get_new_uptoken:!1,multi_selection:!0,domain:b,max_retries:1,dragdrop:!0,drop_element:"imgbox",chunk_size:"4mb",auto_start:!1,filters:{mime_types:[{title:"Image files",extensions:"jpg,jpeg,png"}],max_file_size:v},init:{QueueChanged:function(e){},FilesAdded:function(e,t){console.log(e.files.length),t.length>5||e.files.length>h?(console.log("最多只能选择5张图片"),plupload.each(t,function(t){e.removeFile(t)})):(plupload.each(t,function(e){c(e)}),e.files.length+m.length>=d&&(r(!0),e.files.length+m.length>=h&&a(!1)))},FilesRemoved:function(e,t){e.files.length<h&&(a(!0),e.files.length<d&&r(!1))},BeforeUpload:function(e,t){},UploadProgress:function(e,t){l(t)},FileUploaded:function(t,o,l){n(o),console.log(l);var r=e.parseJSON(l);console.log(r.key);var a=b+r.key;m.push(a),i(o.id,a)},Error:function(e,t,i){t&&t.code==plupload.FILE_SIZE_ERROR?alert("图片大小超过"+v+"了"):t&&t.code==plupload.FILE_EXTENSION_ERROR&&alert("当前选择的文件不符合要求,请检查要上传的文件是否为jpg/png/jpeg")},UploadComplete:function(){},Key:function(e,t){var i=(new Date).format("yyyy-MM-dd"),n=Date.now().toString(),o="."+t.name.split(".")[1],l="show/"+i+"/"+n+o;return l}}});e(".img-preview-list").delegate(".remove","click",function(){console.log(k.files);var i=e(this),n=i.closest("li"),o=k.getFile(n.attr("id"));if(o&&k.removeFile(o),console.log(k.files),n.remove(),n.data("url")&&n.data("url").indexOf(b)>=0){t(m,n.data("url"));var l=e(".form-filed").find('input[name="thumbnail"]');n.data("url")==l.val()&&l.val("")}console.log(m)}),e(".pickfiles").on("click",function(){return!1}),e("#up-imgs").on("click",function(){var e=k.files.length;return e>=d&&e<=h&&(k.start(),console.log("start up imgs"),r(!1)),console.log(e),!1}),e(".img-preview-list").delegate(".set-cover","click",function(){var t=e(".form-filed").find('input[name="thumbnail"]');e(this).data("url").indexOf(b)>=0&&(t.val(e(this).data("url")),e(".img-preview-list").find(".set-cover").text("设为封面"),e(this).text("封面"))}),e(".submit-btn").find("button").on("click",function(){if(console.log("click"),!p())return!1})});