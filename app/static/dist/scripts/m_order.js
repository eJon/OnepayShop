require(["jquery","pingpp-js"],function(a,n){function o(){var a=!1;return console.log(c,d,i.amount),"购买"!=i.charge_type&&(i.charge_type="购买"),"NaN"!=i.amount.toString()&&"NaN"!=i.pid.toString()&&i.amount>0&&i.pid>0&&("微信"==i.pay_method&&"wx_pub"==i.channel?a=!0:"余额"==i.pay_method?(t(i),a=!0):"优惠券"==i.pay_method&&c.length>0&&d>=i.amount?(t(i),a=!0):e.show("表单错误","请检查后重新提交")),a}function t(n){var o=a("form");o.find("#amount").val(n.amount),o.find("#pay_method").val(n.pay_method),o.find("#channel").val(n.channel),"购买"!=o.find("#charge_type").val()&&o.find("#charge_type").val("购买")}var e={show:function(n,o){var t=a("#tips_dialog");t.find(".weui_dialog_hd").text(n),t.find(".weui_dialog_bd").text(o),a("#tips_dialog").show()},bind:function(){a("#tips_dialog").on("click",".weui_btn_dialog",function(){a("#tips_dialog").hide()})}};e.bind();var i={charge_type:"购买"};i.pay_method=a("#pay_method").val(),i.channel=a("#channel").val();var c=a("#coupon").val(),d=Number(a("#coupon").data("amount"));a("#submit-btn").on("click",function(){var t=a(this);return!!o()&&("微信"==i.pay_method?(t.attr("disabled",!0),t.addClass("weui_btn_disabled"),a.post("/charge",i,function(o,t){"success"==t&&o&&("创建订单失败"==o||"订单数据不合法"==o?(a(this).attr("disabled",!1),a(this).removeClass("weui_btn_disabled")):n.createPayment(o,function(n,t){if("success"==n){var i=JSON.parse(o),c="/charge/result/"+i.order_no;a.get(c,function(a){a.status&&location.replace("/pay/result?para="+i.order_no)})}else"fail"==n?e.show("支付结果","支付失败,请尝试重新提交订单"):"cancel"==n&&console.log("取消付款")}))}),!1):void 0)}),a('input[name="methods"]').on("change",function(){i.pay_method=a(this).val(),i.channel=a(this).data("channel")}),a(".coupon-list").on("click",".coupon",function(){var n=a(this);n.closest(".coupon-list").find(".coupon-checked").removeClass("coupon-checked"),n.find(".check-flag").addClass("coupon-checked"),a("#coupon").val(n.data("code")),c=n.data("code"),d=Number(n.data("amount"))}),i.pid=Number(a(".order-count").data("pid")),i.amount=Number(a(".order-count").data("count"))});