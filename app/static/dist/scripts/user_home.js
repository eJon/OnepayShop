require(["jquery","plupload","qiniu"],function(e){function t(){var t=e(".info-list").data("id");return t}function n(){var e=location.pathname;return e.indexOf("zj")>0?"win":e.indexOf("show")>0?"show":e.indexOf("cz")>0?"cz":e.indexOf("address")>0?"address":"join"}function i(t){e("#edit-avatar").prev("img").attr("src",t)}function a(n){e.ajax({url:"/update/avatar/"+t(),type:"PUT",data:{avatar:n},success:function(e,t){console.log(e)}})}Handlebars.registerHelper("compare",function(e,t,n){return e>t?n.fn(this):n.inverse(this)}),function(){function i(t,n,i){e.get(t,function(t,r){if("success"==r&&"ok"==t.message)if(t.data&&t.data.length>0){var l=Handlebars.templates[i](t);n.append(l),20==t.data.length?(s+=1,o.bind("scroll",a)):e(".tips").fadeIn()}else e(".tips").fadeIn()})}function a(n){var p=window.innerHeight?window.innerHeight:o.height(),d=o.scrollTop()+p>r.height()-100,c=o.scrollTop()>l;if(d&&c){o.unbind("scroll",a),l=o.scrollTop();var g,f,h;if("join"==u)g="/api/v1.0/user_join?uid="+t()+"&page="+s,f=e("table .join-body"),h="join_tpl";else if("win"==u)g="/api/v1.0/user_win?uid="+t()+"&page="+s,f=e(".lucky-body"),h="lucky_tpl";else{if("cz"!=u)return"show"==u?(g="/api/v1.0/user_show?uid="+t()+"&page="+s,void(h="show_tpl")):void 0;g="/api/v1.0/user_cz?uid="+t()+"&page="+s,f=e(".cz-body"),h="charge_tpl"}g&&f&&h&&i(g,f,h)}}var o=e(window),r=e(document),s=2,l=0,u=n();o.bind("scroll",a)}(),Date.prototype.format=function(e){var t={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};/(y+)/.test(e)&&(e=e.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var n in t)new RegExp("("+n+")").test(e)&&(e=e.replace(RegExp.$1,1==RegExp.$1.length?t[n]:("00"+t[n]).substr((""+t[n]).length)));return e};var o=(location.pathname,"1MB"),r="http://img.aixunbang.com/",s="/get/qiniu/uptoken";Qiniu.uploader({runtimes:"html5,flash,html4",browse_button:"edit-avatar",uptoken_url:s,get_new_uptoken:!1,multi_selection:!1,domain:r,max_retries:1,dragdrop:!1,drop_element:"imgbox",chunk_size:"4mb",auto_start:!0,filters:{mime_types:[{title:"Image files",extensions:"jpg,jpeg,png"}],max_file_size:o},init:{QueueChanged:function(e){},FileUploaded:function(t,n,o){console.log(o);var s=e.parseJSON(o);console.log(s.key);var l=r+s.key;i(l),a(l)},Error:function(e,t,n){t&&t.code==plupload.FILE_SIZE_ERROR?alert("图片大小超过"+o+"了"):t&&t.code==plupload.FILE_EXTENSION_ERROR&&alert("当前选择的文件不符合要求,请检查要上传的文件是否为jpg/png/jpeg")},UploadComplete:function(){},Key:function(e,t){var n=(new Date).format("yyyy-MM-dd"),i=Date.now().toString(),a="."+t.name.split(".")[1],o="avatar/"+n+"/"+i+a;return o}}})});